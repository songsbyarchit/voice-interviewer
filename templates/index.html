<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Voice Interviewer - MVP</title>
  <style>
    /* Basic styling */
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
    }
    button {
      margin: 0.5rem 0;
      padding: 0.5rem 1rem;
      font-size: 1rem;
    }
    #transcript {
      display: block;
      width: 100%;
      height: 150px;
      margin-top: 1rem;
    }
  </style>
</head>
<body>

  <h1>Voice Interviewer MVP</h1>

  <!-- Buttons -->
  <button id="startBtn">Start Recording</button>
  <button id="stopBtn" disabled>Stop Recording</button> <!-- Stop button, initially disabled -->
  <button id="sendToSheetsBtn">Send to Sheets</button>

  <!-- Transcript display -->
  <textarea id="transcript" placeholder="Your transcription will appear here..."></textarea>

  <script>
    const sessionId = Math.random().toString(36).substring(2, 15);
    const apiKey = "{{ openai_api_key }}";

    // Check browser support
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let isListening = false;

    if (SpeechRecognition) {
      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;

      recognition.addEventListener('result', (event) => {
        let transcript = '';
        for (let i = 0; i < event.results.length; i++) {
          transcript += event.results[i][0].transcript;
        }
        document.getElementById('transcript').value = transcript;
      });

      recognition.addEventListener('start', () => {
        console.log('Speech recognition started');
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;
      });

      recognition.addEventListener('end', () => {
        console.log('Speech recognition ended');
        if (isListening) recognition.start();
      });
    } else {
      alert('Sorry, your browser does not support Speech Recognition');
    }

    document.getElementById('startBtn').addEventListener('click', () => {
      if (!isListening && recognition) {
        isListening = true;
        recognition.start();
      }
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
      if (isListening && recognition) {
        isListening = false;
        recognition.stop();
        document.getElementById('startBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
      }
    });

    document.getElementById('sendToSheetsBtn').addEventListener('click', async () => {
      const transcriptText = document.getElementById('transcript').value.trim();
      if (!transcriptText) {
        alert('No transcription available to send.');
        return;
      }

      try {
        await sendToGoogleSheets(transcriptText);
      } catch (error) {
        console.error('Error sending transcription to Sheets:', error);
        alert('Error sending transcription to Sheets. Check the console.');
      }
    });

    async function sendToGoogleSheets(transcriptText) {
      console.log("Sending transcription to backend...");
      const apiUrl = 'http://localhost:5000/send-to-sheets';

      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ transcription: transcriptText, session_id: sessionId }),
      });

      if (!response.ok) {
        throw new Error(`Backend error: ${response.status} - ${response.statusText}`);
      }

      const data = await response.json();
      console.log("Response Data:", data);

      if (data.missing) {
        await handleMissingAchievements(data.missing);
      } else {
        alert(data.message);
      }
    }

        async function handleMissingAchievements(missingType) {
      let isComplete = false;

      while (!isComplete) {
        let physicalAchievement = "";
        let socialAchievement = "";

        if (missingType === "both") {
          alert("Both achievements are missing! Please provide them below or skip.");
        } else if (missingType === "physical") {
          alert("Physical achievement is missing! Please provide it below or skip.");
        } else if (missingType === "social") {
          alert("Social achievement is missing! Please provide it below or skip.");
        }

        if (missingType !== "social") {
          physicalAchievement = prompt("Enter your physical achievement or leave blank to skip:") || "";
        }
        if (missingType !== "physical") {
          socialAchievement = prompt("Enter your social achievement or leave blank to skip:") || "";
        }

        // Send both to backend for re-validation
        const validationResponse = await validateWithBackend(physicalAchievement, socialAchievement);

        if (validationResponse.complete) {
          isComplete = true; // Exit the loop if validation is complete
          alert("All achievements added successfully!");
        } else {
          missingType = validationResponse.missing; // Update missing type based on response
          if (!physicalAchievement && !socialAchievement) {
            alert("You skipped both. Submitting available data.");
            isComplete = true; // Stop asking for input
          } else {
            alert(validationResponse.message);
          }
        }
      }
    }

    async function validateWithBackend(physical, social) {
      const apiUrl = 'http://localhost:5000/send-to-sheets';

      const payload = {
        session_id: sessionId,
        physical_achievement: physical || "",
        social_win: social || "",
      };

      const response = await fetch(apiUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!response.ok) {
        throw new Error(`Backend error: ${response.status} - ${response.statusText}`);
      }

      return await response.json();
    }
  </script>
</body>
</html>